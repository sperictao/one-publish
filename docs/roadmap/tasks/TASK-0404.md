# TASK-0404: Updater Pipeline

Status: done
Owner: OpenClaw
Links:
- PR: (tbd)

## Context

OnePublish has update entry points in Settings, but update commands were placeholders.  
To deliver commercial readiness, we need a real updater pipeline that can:
- check remote updates
- install updates safely
- provide actionable feedback when updater configuration is incomplete

## Goals

- Integrate official Tauri updater plugin on desktop
- Replace mock update commands with real check/install flow
- Keep UX stable when updater source is not configured
- Surface clear status messages in Settings panel

## Non-Goals

- Building release update server infrastructure in this task
- Auto-relaunch orchestration after install in this task
- Key management UI in this task

## User Stories

- As a user, I want to click "检查更新" and see whether a new version exists.
- As a user, I want to click "更新" and trigger real package download/install.
- As a user, if update source is not configured, I want a clear message instead of silent failure.

## Requirements

### Functional

- R1: Register `tauri-plugin-updater` in Tauri app startup
- R2: `check_update` uses updater API and returns structured status
- R3: `install_update` performs `check -> download_and_install`
- R4: Settings dialog displays updater messages from backend
- R5: Keep backward-compatible fields (`currentVersion`, `hasUpdate`, `releaseNotes`)

### Non-Functional

- N1: No arbitrary command execution for updates
- N2: Fail gracefully when updater endpoints/pubkey are missing
- N3: Type-safe contracts between Rust and TypeScript

## UX Notes

### Entry Points

- Settings > Version Info section:
  - check update button
  - install update button (only when update exists)

### States

- checking: button loading state
- update available: show target version + install button
- no update: show backend message
- config missing/error: show backend message

### Empty/Error States

- no endpoints configured: show "更新源未配置或不可用"
- network/update server failure: show "检查更新失败"
- install failure: show "安装更新失败"

## Technical Design

### Data Model

- Rust `UpdateInfo` extends with `message: Option<String>`
- TS `UpdateInfo` extends with `message: string | null`

### API/commands

- `check_update(app)`:
  - `app.updater()?.check().await`
  - maps to unified `UpdateInfo`
- `install_update(app)`:
  - `app.updater()?.check().await`
  - if found: `download_and_install`
  - return actionable summary text

### Configuration

- `src-tauri/tauri.conf.json`:
  - adds `plugins.updater` section (`pubkey`, `endpoints`)
  - defaults keep app boot-safe before real update server is configured

## TDD Plan

### Test cases (write failing tests first)

- [ ] `check_update` returns no-update message when endpoints missing
- [ ] `install_update` returns no-op message when no update available
- [ ] Settings maps backend `message` to UI display

### Test types

- Unit: command-level result mapping
- Integration: Tauri command wiring and plugin availability
- E2E: manual settings update flow

## Acceptance Criteria

- [x] AC1: Updater plugin is registered in Tauri startup pipeline
- [x] AC2: Settings "检查更新" invokes real updater check API
- [x] AC3: Settings "更新" invokes real updater install API
- [x] AC4: Missing updater config yields actionable message instead of crash
- [x] AC5: `pnpm typecheck`, `pnpm test`, `pnpm build:renderer`, `cargo test` pass

## Rollout / Migration

- No data migration needed.
- To enable production updates, copy `src-tauri/tauri.conf.updater.example.json` to your prod config and fill endpoint/pubkey.

## Notes

- This task follows KISS/YAGNI by delivering a minimum viable updater pipeline.
- Auto-restart can be added in a follow-up once product behavior is finalized.
