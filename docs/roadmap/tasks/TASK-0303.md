# TASK-0303: Command Import

Status: done
Owner: OpenClaw
Links:
- PR: (tbd)

## Context

Users often have existing build commands that work correctly. Rather than manually configuring all parameters, we can parse these commands and generate a PublishSpec with the appropriate parameters.

## Goals

- Parse CLI commands for each provider (dotnet, cargo, go, gradle)
- Extract parameters and map them to schema-defined parameters
- Generate PublishSpec from parsed command
- Support common flag patterns (short flags, long flags, quoted values)

## Non-Goals

- Perfect parsing of all possible command variations
- Command line argument validation
- Interactive command import (initially import as text)

## User Stories

- As a developer, I want to paste my existing build command and have it auto-generate parameters.
- As a developer, I want to quickly switch between multiple build configurations without re-typing flags.

## Requirements

### Functional

- R1: Parse dotnet publish commands and extract parameters
- R2: Parse cargo build commands and extract parameters
- R3: Parse go build commands and extract parameters
- R4: Parse gradlew build commands and extract parameters
- R5: Map parsed flags to provider schema parameter keys
- R6: Generate PublishSpec from parsed parameters
- R7: Import command dialog in UI (text input + import button)

### Non-Functional

- N1: Parsing is forgiving (doesn't crash on unknown flags)
- N2: Common patterns work well (edge cases can be ignored in v1)
- N3: Import result shows what was extracted (user can verify)

## UX Notes

### Entry Points

- Main publish panel: "Import from command" button
- Settings dialog: Quick import option

### States

- Input: Text area for command input
- Processing: Parsing command
- Result: Show extracted parameters
- Error: Parse failed message

### Empty/Error States

- Empty: Show "Enter a build command..."
- Error: "Could not parse this command. Check format and try again."

## Technical Design

### Parser Module (Rust)

```rust
// src-tauri/src/command_parser.rs
pub struct CommandParser {
    provider_id: String,
}

impl CommandParser {
    pub fn parse_command(&self, command: &str) -> Result<PublishSpec, ParseError>;
}

pub enum ParseError {
    UnknownCommand,
    InvalidFlag(String),
    MissingValue(String),
}
```

### Supported Commands

**dotnet:**
```
dotnet publish MyProject.csproj -c Release -r win-x64 --self-contained
dotnet publish --configuration Debug --output ./publish
```

**cargo:**
```
cargo build --release --target x86_64-apple-darwin
cargo build --features "feature1,feature2"
```

**go:**
```
go build -o myapp -tags production
GOOS=linux GOARCH=amd64 go build
```

**gradle:**
```
./gradlew build -Dversion=1.2.3 --offline
./gradlew assemble -x test
```

### Tauri Command

```rust
#[tauri::command]
pub async fn import_from_command(
    command: String,
    provider_id: String,
) -> Result<PublishSpec, AppError>
```

### UI Component

```typescript
// src/components/publish/CommandImportDialog.tsx
interface CommandImportDialogProps {
  providerId: string;
  onImport: (spec: PublishSpec) => void;
  onClose: () => void;
}
```

## TDD Plan

### Test cases (write failing tests first)

- [x] Parser extracts boolean flags
- [x] Parser extracts string flags with values
- [x] Parser extracts array flags (comma-separated)
- [x] Parser extracts map flags (key=value)
- [x] Parser handles quoted values
- [x] Parser ignores unknown flags (returns error or warning)
- [x] dotnet publish command parsed correctly
- [x] cargo build command parsed correctly
- [x] go build command parsed correctly
- [x] gradlew build command parsed correctly
- [x] Import dialog calls backend and emits spec

### Test types

- Unit: Parser logic for each provider
- Integration: Import command â†’ spec generation
- E2E: User pastes command, imports, parameters appear

## Acceptance Criteria

- [x] AC1: `cargo test --manifest-path src-tauri/Cargo.toml` passes with parser tests
- [x] AC2: All 4 providers can parse common command patterns
- [x] AC3: Import dialog successfully generates PublishSpec
- [x] AC4: Extracted parameters match schema definitions
- [x] AC5: Invalid commands return clear error messages

## Rollout / Migration

- Phase 1: Create parser module with basic pattern matching
- Phase 2: Add Tauri command for import
- Phase 3: Create UI dialog component
- Phase 4: Integrate into main publish panel

## Notes

- Use regex for basic pattern matching (simple cases only)
- Don't try to handle all edge cases in v1
- Unknown flags should be skipped or produce warnings
- Consider supporting command history (saved imports)
- Future: Could analyze project and suggest commands

## Implementation Details

### Parser Strategy

1. **Tokenize** command string into words
2. **Identify** provider-specific patterns
3. **Extract** flags and values
4. **Map** to schema parameter keys
5. **Generate** PublishSpec

### Flag Mapping

| Flag Pattern | Schema Key | Provider |
|--------------|-------------|-----------|
| `-c`, `--configuration` | `configuration` | dotnet |
| `-r`, `--runtime` | `runtime` | dotnet |
| `--release` | `release` | cargo |
| `--target` | `target` | cargo |
| `-o` | `output` | go |
| `GOOS`, `GOARCH` | (env vars) | go |
| `-D` | `properties` | java |

### Complexity Notes

- **Easy**: Simple flags with single values (dotnet -c Release)
- **Medium**: Array flags (comma-separated lists)
- **Hard**: Map flags with key=value pairs
- **Very Hard**: Quoted values with spaces, escape sequences

For v1, focus on Easy + Medium cases.
