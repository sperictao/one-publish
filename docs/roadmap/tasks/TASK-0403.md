# TASK-0403: Packaging + Signing Abstraction

Status: done
Owner: OpenClaw
Links:
- PR: (tbd)

## Context

Today, OnePublish produces an output directory after `publish`, but shipping often requires:
- A single distributable artifact (zip/tar/installer)
- Integrity verification (checksums)
- Optional signatures (GPG/code signing) before distribution

Packaging/signing must be **provider-agnostic**: it operates on a produced output path, not on a specific language toolchain.

## Goals

- Provide a minimal, extensible packaging abstraction (start with ZIP)
- Provide a minimal, extensible signing abstraction (start with GPG detached signature)
- Integrate into UI as a post-publish action (manual, opt-in)
- Keep the system safe: no arbitrary command execution

## Non-Goals

- Building platform installers (MSI/DMG/PKG) in this task
- Full OS-native code signing (codesign/signtool/notary) in this task
- Key management UX (import/store private keys) in this task

## User Stories

- As a developer, I want to package the publish output into a `.zip`, so I can distribute a single file.
- As a developer, I want to generate a detached signature for the artifact, so recipients can verify integrity.
- As a developer, I want to see artifact metadata (size/checksum), so I can validate what was produced.

## Requirements

### Functional

- R1: Package a directory into a single artifact file (ZIP).
- R2: Let the user choose the artifact output path.
- R3: Return artifact metadata: path, file count, byte size, sha256 checksum.
- R4: Support a signing step that produces a detached signature file (GPG, `.asc`).
- R5: UI: expose "Package" and "Sign" actions after a successful publish.
- R6: Signing must be opt-in and bounded to known methods (no generic "run command").

### Non-Functional

- N1: Cross-platform behavior documented (macOS/Windows/Linux).
- N2: Errors are actionable (missing tools, invalid paths, permission errors).
- N3: No secrets stored in plain text (no private key storage).
- N4: Fast enough for typical publish output sizes; run heavy IO off the async runtime.

## UX Notes

### Entry Points

- Post-publish panel: show actions when publish succeeds:
  - `Package (ZIP)`
  - `Sign (GPG)` (enabled only after packaging completes)

### States

- Packaging: disabled buttons + progress indicator
- Packaged: show artifact path + checksum summary
- Signing: disabled buttons + progress indicator
- Signed: show signature path + command output if needed

### Empty/Error States

- Output directory missing: show error and disable packaging
- User cancels save dialog: no-op
- GPG not installed / command fails: show error and keep artifact usable

## Technical Design

### Data Model

- `PackageFormat`: `zip` (extend later)
- `PackageResult`: `artifact_path`, `format`, `file_count`, `bytes`, `sha256`
- `SignMethod`: `gpg_detached` (extend later)
- `SignResult`: `signature_path`, `method`, `stdout`, `stderr`, `exit_code`, `success`

### API/Commands

- `package_artifact(input_dir, output_path, format?, include_root_dir?) -> PackageResult`
- `sign_artifact(artifact_path, method, output_path?, key_id?) -> SignResult`

### Security / Safety

- Packaging is implemented in Rust (zip crate) without invoking external tools.
- Signing supports only enumerated methods and uses fixed argument templates (no arbitrary shell).

### Storage

- No persistence in this task (results live in UI state).

## TDD Plan

### Test cases (write failing tests first)

- [ ] Zipping a directory produces a valid zip with expected entries
- [ ] `include_root_dir=false` does not prefix paths
- [ ] SHA256 is a 64-char hex string and stable for a given output

### Test types

- Unit: zip packaging and hashing
- Integration: tauri command wiring (optional)
- E2E: manual validation via GUI

## Acceptance Criteria

- [ ] AC1: `cargo test --manifest-path src-tauri/Cargo.toml` passes
- [ ] AC2: After a successful publish, user can package output to zip via UI
- [ ] AC3: Packaged artifact includes checksum + size metadata
- [ ] AC4: If `gpg` exists, user can generate `.asc` detached signature via UI

## Rollout / Migration

- No migration required; feature is opt-in post-publish action.

## Notes

- Future extensions:
  - `tar.gz`/`tar.zst`
  - Installer builders (WiX, pkgbuild, etc.)
  - Platform signers (codesign + notarytool, signtool)
  - Integrate signer presence into TASK-0402 environment checking
