# TASK-0301: Parameter Schema + Renderer

Status: done
Owner: OpenClaw
Links:
- PR: (tbd)

## Context

Current PublishSpec supports limited parameters (key-value). To achieve 100% parameter expressiveness for all language providers (dotnet, cargo, go, java), we need a schema-driven approach that can represent any CLI flag, environment variable, or argument.

## Goals

- Define a JSON schema for describing provider parameters (flags, env vars, args)
- Create a renderer that converts parameters into actual CLI commands
- Support common parameter types: boolean flags, key-value pairs, multi-value lists, raw strings

## Non-Goals

- UI generation from schema (that's TASK-0302)
- Schema validation UI feedback
- Parameter import from existing commands (that's TASK-0303)

## User Stories

- As a provider maintainer, I want to define parameters declaratively so that they can be rendered correctly.
- As a compiler, I want to convert spec parameters into CLI commands based on provider schemas.

## Requirements

### Functional

- R1: Parameter schema JSON format supports: boolean flags, string values, multi-value arrays, key-value maps
- R2: Each provider has a `parameters.json` manifest defining its supported parameters
- R3: Renderer converts PublishSpec parameters into CLI command parts (flags, env, args)
- R4: Supports parameter ordering and grouping

### Non-Functional

- N1: Schema is language-agnostic and extensible
- N2: Renderer produces consistent, predictable output
- N3: Errors clearly indicate which parameter is invalid

## UX Notes

- Schema format should be intuitive for developers
- Parameter types should cover all common CLI patterns

## Technical Design

### Parameter Schema Format

```json
{
  "parameters": {
    "release": {
      "type": "boolean",
      "flag": "--release",
      "description": "Build in release mode"
    },
    "target": {
      "type": "string",
      "flag": "--target",
      "multiple": false,
      "description": "Target triple"
    },
    "features": {
      "type": "array",
      "flag": "--features",
      "description": "List of features to enable"
    },
    "defines": {
      "type": "map",
      "prefix": "--define=",
      "description": "Preprocessor defines"
    }
  }
}
```

### Renderer API

```rust
pub struct ParameterRenderer {
    schema: ParameterSchema,
}

impl ParameterRenderer {
    pub fn render(&self, params: &BTreeMap<String, SpecValue>) -> Result<RenderedCommand, RenderError>;
}

pub struct RenderedCommand {
    pub args: Vec<String>,
    pub env: Vec<(String, String)>,
}
```

### Integration Points

- Provider manifest loads `parameters.json` from provider package
- Compiler uses renderer to convert spec → command
- ExecutionPlan includes raw args and env

## TDD Plan

### Test cases (write failing tests first)

- [x] Schema parses valid JSON into ParameterSchema
- [x] Boolean flag renders as `--flag` (when true) or omitted (when false)
- [x] String value renders as `--flag value`
- [x] Array renders as multiple `--flag value` pairs
- [x] Map renders as `--prefix key=value` for each entry
- [x] Unknown parameter type returns error
- [x] Missing required parameter returns error
- [x] Multi-value flag with no value returns empty list

### Test types

- Unit: Schema parsing, individual parameter rendering
- Integration: Full spec → command rendering for each provider
- E2E: Execute rendered command and verify output

## Acceptance Criteria

- [x] AC1: `cargo test --manifest-path src-tauri/Cargo.toml` passes with new renderer tests
- [x] AC2: All providers (dotnet, cargo, go, java) have `parameters.json` manifests
- [x] AC3: Rendering produces correct CLI syntax for all parameter types
- [x] AC4: Invalid parameters produce clear error messages

## Rollout / Migration

- Existing PublishSpec format remains backward compatible
- New `parameters` field in PublishSpec uses schema-driven rendering
- Old-style params still work via fallback path

## Notes

- Schema design should consider future UI generation (TASK-0302)
- Flag naming conventions should follow CLI best practices
- Consider parameter dependencies (e.g., `--flag` requires `--value`)

## Implementation Details

### Files Created

- `src-tauri/src/parameter.rs` - Core parameter module with schema and renderer
- `src-tauri/src/provider/schemas/dotnet.json` - dotnet parameter definitions
- `src-tauri/src/provider/schemas/cargo.json` - cargo parameter definitions
- `src-tauri/src/provider/schemas/go.json` - go parameter definitions
- `src-tauri/src/provider/schemas/java.json` - java parameter definitions

### Files Modified

- `src-tauri/src/lib.rs` - Added parameter module
- `src-tauri/src/provider/mod.rs` - Added get_schema() to Provider trait
- `src-tauri/src/provider/registry.rs` - Implemented schema loading for all providers
- `src-tauri/src/compiler.rs` - Added compile_with_renderer() function
- `src-tauri/src/errors.rs` - Added RenderError handling

### Test Results

```
running 29 tests
test result: ok. 29 passed; 0 failed
```
